---
interface Tag {
  name: string;
  x: number;
  y: number;
}

interface Photo {
  id: string;
  r2Key: string;
  tags: Tag[];
}

interface Props {
  photo: Photo;
}

const { photo } = Astro.props;

// Determine image source based on environment
const useLocal = import.meta.env.PUBLIC_USE_LOCAL_PHOTOS === 'true';
const imageSrc = useLocal
  ? `/local-photos/${photo.r2Key}`
  : `/api/image/${photo.r2Key}`;
---

<div class="relative group overflow-hidden bg-zinc-900">
  <!-- Image -->
  <img
    src={imageSrc}
    alt={`Photo ${photo.id}`}
    class="photo-card-image w-full h-auto aspect-[16/9] object-cover transition-transform duration-700 ease-in-out opacity-90"
    loading="lazy"
  />

  <!-- Overlay -->
  <div
    class="photo-card-overlay absolute inset-0 bg-black/60 opacity-0 transition-opacity duration-500 pointer-events-none"
  >
    <!-- Tags Container -->
    <div class="relative w-full h-full">
      {
        photo.tags.map((tag) => (
          <div
            class="absolute transform -translate-x-1/2 -translate-y-1/2 flex flex-col items-center pointer-events-auto"
            style={`left: ${tag.x}%; top: ${tag.y}%;`}
          >
            <!-- Marker point -->
            <div class="w-2 h-2 bg-white rounded-full shadow-[0_0_10px_rgba(255,255,255,0.5)]" />

            <!-- Label (always visible when overlay is shown) -->
            <div class="mt-2">
               <span class="bg-black/60 text-white text-[10px] tracking-wider uppercase font-medium px-2 py-1 backdrop-blur-md border border-white/10 whitespace-nowrap shadow-xl">
                {tag.name}
              </span>
            </div>
          </div>
        ))
      }
    </div>
  </div>

  {photo.tags.length > 0 && (
    <button
      class="card-info-toggle absolute bottom-3 right-3 z-20 w-8 h-8 rounded-full bg-white/20 backdrop-blur-md border border-white/30 flex items-center justify-center text-white sm:hidden transition-all active:scale-90"
      aria-label="Toggle tags"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>
    </button>
  )}
</div>

<script>
  // Handle info toggle on mobile for PhotoCard
  const initPhotoCardToggles = () => {
    const buttons = document.querySelectorAll('.card-info-toggle');
    buttons.forEach(button => {
      button.removeEventListener('click', togglePhotoCardInfo);
      button.addEventListener('click', togglePhotoCardInfo);
    });
  };

  function togglePhotoCardInfo(e) {
    e.preventDefault();
    e.stopPropagation();
    const container = this.closest('.group');
    container?.classList.toggle('show-info');

    // Change button color when active
    if (container?.classList.contains('show-info')) {
      this.style.backgroundColor = 'rgba(255, 255, 255, 0.4)';
    } else {
      this.style.backgroundColor = 'rgba(255, 255, 255, 0.2)';
    }
  }

  initPhotoCardToggles();
  document.addEventListener('astro:after-swap', initPhotoCardToggles);
</script>

<style>
  @media (hover: hover) {
    .group:hover .photo-card-overlay {
      opacity: 1;
    }

    .group:hover .photo-card-image {
      opacity: 1;
    }
  }

  .group.show-info .photo-card-overlay {
    opacity: 1;
  }

  .group.show-info .photo-card-image {
    opacity: 1;
  }
</style>
