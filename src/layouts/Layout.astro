---
import { getCollection } from 'astro:content';
import '@fontsource/pt-sans/400.css';
import '@fontsource/pt-sans/700.css';
import '@fontsource/noto-sans-tc/300.css';
import '@fontsource/noto-sans-tc/400.css';
import '@fontsource/noto-sans-tc/500.css';
import '@fontsource/noto-sans-tc/700.css';

interface Props {
	title: string;
}

const { title } = Astro.props;

// Fetch folders for the navigation bar
const folders = await getCollection('folders');
const sortedFolders = folders.sort((a, b) => a.data.order - b.data.order);

// Get the current path to highlight active link
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="RIVERBED" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
	</head>
	<body class="bg-zinc-950 text-zinc-100 min-h-screen antialiased selection:bg-white/20">
		<nav id="navbar" class="fixed top-0 left-0 right-0 z-50 bg-zinc-950/80 backdrop-blur-md border-b border-white/10 transition-transform duration-300 ease-in-out">
			<div class="mx-auto px-4 h-16 flex items-center relative">
				<!-- Navigation - Left Aligned -->
				<div class="flex gap-4">
					{sortedFolders.map(folder => {
						const isActive = currentPath.startsWith(`/${folder.id}`);
						return (
							<a
								href={`/${folder.id}`}
								class={`text-sm font-light transition-all hover:text-white relative py-1 ${
									isActive ? 'text-white' : 'text-zinc-400'
								}`}
							>
								{folder.data.title}
								{isActive && (
									<span class="absolute bottom-0 left-0 right-0 h-0.5 bg-white rounded-full"></span>
								)}
							</a>
						);
					})}
				</div>

				<!-- Logo - Centered -->
				<div class="absolute left-1/2 -translate-x-1/2">
					<a href="/" class="text-xl font-normal tracking-tighter hover:text-white transition-colors">
						RIVERBED
					</a>
				</div>
			</div>
		</nav>

		<main class="mx-auto px-2 pt-20 pb-20">
			<slot />
		</main>

		<script>
			let lastScrollY = window.scrollY;
			const navbar = document.getElementById('navbar');

			window.addEventListener('scroll', () => {
				const currentScrollY = window.scrollY;

				if (currentScrollY > lastScrollY && currentScrollY > 100) {
					// Scrolling down - hide navbar
					navbar?.classList.add('-translate-y-full');
				} else {
					// Scrolling up - show navbar
					navbar?.classList.remove('-translate-y-full');
				}

				lastScrollY = currentScrollY;
			});

			// Keyboard Navigation
			window.addEventListener('keydown', (e) => {
				if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft' && e.key !== 'ArrowDown' && e.key !== 'ArrowUp') return;

				// In photography contexts, "Right/Down" usually means "Next Row"
				// Targets: photo rows in albums, cards in folders/home
				const targets = Array.from(document.querySelectorAll('.photo-row, .album-card, .folder-card'));
				if (targets.length === 0) return;

				const navbarHeight = 80; // Approximate height including padding
				const scrollPadding = 20;
				const currentPos = window.scrollY + navbarHeight + scrollPadding;

				// Find the first target that is currently visible or below the current position
				const nextIndex = targets.findIndex(t => {
					const rect = t.getBoundingClientRect();
					return (window.scrollY + rect.top) > currentPos;
				});

				let target;
				if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
					// Go to next
					if (nextIndex !== -1) {
						target = targets[nextIndex];
					}
				} else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
					// Go to previous
					// If nextIndex is -1, it means we are past all targets
					const currentIndex = nextIndex === -1 ? targets.length : nextIndex;
					if (currentIndex > 1) {
						target = targets[currentIndex - 2];
					} else if (currentIndex === 1) {
						// Scroll to top if on first item
						window.scrollTo({ top: 0, behavior: 'smooth' });
						return;
					}
				}

				if (target) {
					const targetTop = window.scrollY + target.getBoundingClientRect().top - navbarHeight + 10;
					window.scrollTo({ top: targetTop, behavior: 'smooth' });
					e.preventDefault(); // Prevent default scroll
				}
			});
		</script>
	</body>
</html>

<style is:global>
	/* Elegant scrollbar */
	::-webkit-scrollbar {
		width: 8px;
	}
	::-webkit-scrollbar-track {
		background: #09090b;
	}
	::-webkit-scrollbar-thumb {
		background: #27272a;
		border-radius: 4px;
	}
	::-webkit-scrollbar-thumb:hover {
		background: #3f3f46;
	}

	:root {
		font-family: 'PT Sans', 'Noto Sans TC', sans-serif;
	}

	body {
		font-family: 'PT Sans', 'Noto Sans TC', sans-serif;
	}
</style>
