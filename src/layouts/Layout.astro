---
import { getCollection } from 'astro:content';
import { getFolderTitle, getFolderOrder } from '../lib/constants';
import '@fontsource/fjalla-one';
import '@fontsource/pt-sans/400.css';
import '@fontsource/pt-sans/700.css';
import '@fontsource/noto-sans-tc/300.css';
import '@fontsource/noto-sans-tc/400.css';
import '@fontsource/noto-sans-tc/500.css';
import '@fontsource/noto-sans-tc/700.css';
import 'photoswipe/dist/photoswipe.css';

interface Props {
	title: string;
}

const { title } = Astro.props;

// Fetch unique folders from album slugs for navigation
const albums = await getCollection('albums');
const folderSlugs = [...new Set(albums.map(album => album.slug.split('/')[0]))];

const sortedFolders = folderSlugs
    .map(slug => ({
        id: slug,
        title: getFolderTitle(slug),
        order: getFolderOrder(slug)
    }))
    .sort((a, b) => a.order - b.order);

// Get the current path to highlight active link
const currentPath = Astro.url.pathname;
---

<!doctype html>
<html lang="en" class="scroll-smooth">
	<head>
		<meta charset="UTF-8" />
		<meta name="description" content="RIVERBED" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/x-icon" href="/favicon.ico" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
	</head>
	<body class="bg-zinc-950 text-zinc-100 min-h-screen antialiased selection:bg-white/20">
		<nav id="navbar" class="fixed top-0 left-0 right-0 z-50 bg-zinc-950/80 backdrop-blur-md border-b border-white/10 transition-transform duration-300 ease-in-out">
			<div class="mx-auto px-4 h-16 flex items-center relative">
				<!-- Menu Toggle - Mobile Only -->
				<button id="menu-toggle" class="sm:hidden p-1 text-zinc-400 hover:text-white transition-colors" aria-label="Toggle menu">
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="menu-icon"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
					<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="close-icon hidden"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
				</button>

				<!-- Navigation - Desktop -->
				<div class="hidden sm:flex gap-4">
					{sortedFolders.map(folder => {
						const isActive = currentPath.startsWith(`/${folder.id}`);
						return (
							<a
								href={`/${folder.id}`}
								class={`text-sm font-fjalla tracking-wide transition-all hover:text-white relative py-1 ${
									isActive ? 'text-white' : 'text-zinc-400'
								}`}
							>
								{folder.title}
								{isActive && (
									<span class="absolute bottom-0 left-0 right-0 h-0.5 bg-white rounded-full"></span>
								)}
							</a>
						);
					})}
				</div>

				<!-- Logo - Centered -->
				<div class="absolute left-1/2 -translate-x-1/2">
					<a href="/" class="text-xl font-fjalla tracking-[0.2em] hover:text-white transition-colors">
						RIVERBED
					</a>
				</div>
			</div>

			<!-- Mobile Navigation Dropdown -->
			<div id="mobile-menu" class="hidden sm:hidden border-t border-white/5 bg-zinc-950/95 backdrop-blur-xl overflow-hidden transition-all duration-300 ease-in-out max-h-0">
				<div class="flex flex-col p-4 gap-4">
					{sortedFolders.map(folder => {
						const isActive = currentPath.startsWith(`/${folder.id}`);
						return (
							<a
								href={`/${folder.id}`}
								class={`text-base font-fjalla tracking-wide transition-all ${
									isActive ? 'text-white' : 'text-zinc-400'
								}`}
							>
								{folder.title}
							</a>
						);
					})}
				</div>
			</div>
		</nav>

		<main class="mx-auto px-2 pt-20 pb-20">
			<slot />
		</main>

		<script>
			let lastScrollY = window.scrollY;
			const navbar = document.getElementById('navbar');
			const menuToggle = document.getElementById('menu-toggle');
			const mobileMenu = document.getElementById('mobile-menu');
			const menuIcon = menuToggle?.querySelector('.menu-icon');
			const closeIcon = menuToggle?.querySelector('.close-icon');

			menuToggle?.addEventListener('click', () => {
				const isExpanded = mobileMenu?.classList.contains('hidden');

				if (isExpanded) {
					// Open
					mobileMenu?.classList.remove('hidden');
					// Trigger browser reflow for transition
					void mobileMenu?.offsetWidth;
					mobileMenu!.style.maxHeight = '500px';
					menuIcon?.classList.add('hidden');
					closeIcon?.classList.remove('hidden');
				} else {
					// Close
					mobileMenu!.style.maxHeight = '0px';
					menuIcon?.classList.remove('hidden');
					closeIcon?.classList.add('hidden');

					// Wait for transition before hiding
					setTimeout(() => {
						if (mobileMenu!.style.maxHeight === '0px') {
							mobileMenu?.classList.add('hidden');
						}
					}, 300);
				}
			});

			window.addEventListener('scroll', () => {
				const currentScrollY = window.scrollY;

				// Close mobile menu on scroll
				if (mobileMenu && !mobileMenu.classList.contains('hidden')) {
					mobileMenu.style.maxHeight = '0px';
					menuIcon?.classList.remove('hidden');
					closeIcon?.classList.add('hidden');
					setTimeout(() => {
						mobileMenu.classList.add('hidden');
					}, 300);
				}

				if (currentScrollY > lastScrollY && currentScrollY > 100) {
					// Scrolling down - hide navbar
					navbar?.classList.add('-translate-y-full');
				} else {
					// Scrolling up - show navbar
					navbar?.classList.remove('-translate-y-full');
				}

				lastScrollY = currentScrollY;
			});

			// Keyboard Navigation
			window.addEventListener('keydown', (e) => {
				if (e.key !== 'ArrowRight' && e.key !== 'ArrowLeft' && e.key !== 'ArrowDown' && e.key !== 'ArrowUp') return;

				// In photography contexts, "Right/Down" usually means "Next Row"
				// Targets: photo rows in albums, cards in folders/home
				const targets = Array.from(document.querySelectorAll('.photo-row, .album-card, .folder-card'));
				if (targets.length === 0) return;

				const navbarHeight = 80; // Approximate height including padding
				const scrollPadding = 20;
				const currentPos = window.scrollY + navbarHeight + scrollPadding;

				// Find the first target that is currently visible or below the current position
				const nextIndex = targets.findIndex(t => {
					const rect = t.getBoundingClientRect();
					return (window.scrollY + rect.top) > currentPos;
				});

				let target;
				if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
					// Go to next
					if (nextIndex !== -1) {
						target = targets[nextIndex];
					}
				} else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
					// Go to previous
					// If nextIndex is -1, it means we are past all targets
					const currentIndex = nextIndex === -1 ? targets.length : nextIndex;
					if (currentIndex > 1) {
						target = targets[currentIndex - 2];
					} else if (currentIndex === 1) {
						// Scroll to top if on first item
						window.scrollTo({ top: 0, behavior: 'smooth' });
						return;
					}
				}

				if (target) {
					const targetTop = window.scrollY + target.getBoundingClientRect().top - navbarHeight + 10;
					window.scrollTo({ top: targetTop, behavior: 'smooth' });
					e.preventDefault(); // Prevent default scroll
				}
			});

			// PhotoSwipe Initialization
			import PhotoSwipeLightbox from 'photoswipe/lightbox';

			let lightbox: PhotoSwipeLightbox | null = null;

			const initPhotoSwipe = () => {
				if (lightbox) {
					lightbox.destroy();
				}

				lightbox = new PhotoSwipeLightbox({
					gallery: '.album-content, .tag-photos, .pswp-gallery, .prose',
					children: '.pswp-link',
					pswpModule: () => import('photoswipe')
				});

				// Initialize dimensions on the fly if not provided
				lightbox.on('beforeOpen', () => {
					const links = document.querySelectorAll('.pswp-link') as NodeListOf<HTMLAnchorElement>;
					links.forEach(link => {
						const img = link.querySelector('img');
						if (img && (!link.dataset.pswpWidth || !link.dataset.pswpHeight)) {
							if (img.naturalWidth) {
								link.dataset.pswpWidth = img.naturalWidth.toString();
								link.dataset.pswpHeight = img.naturalHeight.toString();
							}
						}
					});
				});

				lightbox.init();
			};

			const initDimensions = () => {
				const links = document.querySelectorAll('.pswp-link') as NodeListOf<HTMLAnchorElement>;
				links.forEach(link => {
					const img = link.querySelector('img');
					if (img) {
						if (img.complete) {
							if (img.naturalWidth) {
								link.dataset.pswpWidth = img.naturalWidth.toString();
								link.dataset.pswpHeight = img.naturalHeight.toString();
							}
						} else {
							img.addEventListener('load', () => {
								link.dataset.pswpWidth = img.naturalWidth.toString();
								link.dataset.pswpHeight = img.naturalHeight.toString();
							});
						}
					}
				});
			};

			const initAll = () => {
				initDimensions();
				initPhotoSwipe();
			};

			initAll();
			document.addEventListener('astro:after-swap', initAll);
		</script>
	</body>
</html>

<style is:global>
	/* Elegant scrollbar */
	::-webkit-scrollbar {
		width: 8px;
	}
	::-webkit-scrollbar-track {
		background: #09090b;
	}
	::-webkit-scrollbar-thumb {
		background: #27272a;
		border-radius: 4px;
	}
	::-webkit-scrollbar-thumb:hover {
		background: #3f3f46;
	}

	:root {
		font-family: 'PT Sans', 'Noto Sans TC', sans-serif;
	}

	body {
		font-family: 'PT Sans', 'Noto Sans TC', sans-serif;
	}
</style>
