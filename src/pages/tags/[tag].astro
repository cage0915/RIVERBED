---
import Layout from '../../layouts/Layout.astro';
import Row from '../../components/Row.astro';
import Photo from '../../components/Photo.astro';
import { getAllPhotosWithTags } from '../../utils/tags';

export const prerender = false;

const { tag } = Astro.params;

if (!tag) {
    return Astro.redirect('/404');
}

const allPhotos = await getAllPhotosWithTags();
const decodedTag = decodeURIComponent(tag);
const matchingPhotos = allPhotos.filter(photo =>
    photo.tags.some(t => t.name === decodedTag)
);
---

<Layout title={`#${decodedTag} - RIVERBED`}>
    <div class="fixed top-20 left-4 z-40">
        <a
            href="javascript:history.back()"
            class="group flex items-center gap-2 text-zinc-500 hover:text-white transition-colors"
        >
            <div class="w-8 h-8 rounded-full border border-white/10 flex items-center justify-center group-hover:border-white/30 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </div>
            <span class="text-xs font-light tracking-widest uppercase">Back</span>
        </a>
    </div>

    <main class="container mx-auto px-4 py-8 max-w-5xl">
        <div class="mb-16 text-center">
            <h1 class="text-4xl font-light tracking-tight text-white mb-4">{decodedTag}</h1>
            <div class="h-px w-12 bg-white/20 mx-auto mb-4"></div>
            <p class="text-zinc-500 text-xs font-light tracking-wide uppercase">
                {matchingPhotos.length} {matchingPhotos.length === 1 ? 'photo' : 'photos'} discovered
            </p>
        </div>

        <div class="tag-photos space-y-16">
            {matchingPhotos.map(photo => (
                <div class="tag-photo-entry group">
                    <Row cols={1}>
                        <Photo
                            itemKey={photo.itemKey}
                            caption={photo.caption}
                            tags={photo.tags}
                        />
                    </Row>
                    <div class="mt-4 flex justify-end items-center px-2">
                        <a href={`/${photo.folder}/${photo.albumId}`} class="text-[10px] text-zinc-400 hover:text-white transition-colors tracking-widest uppercase border-b border-transparent hover:border-white/40 pb-0.5">
                            View Full Album â†’
                        </a>
                    </div>
                </div>
            ))}
        </div>

        {matchingPhotos.length === 0 && (
            <div class="text-center py-32">
                <p class="text-zinc-500 font-light italic text-sm">No captures found with this tag.</p>
                <a href="/" class="text-xs mt-8 inline-block text-zinc-400 hover:text-white border border-white/10 px-6 py-2 rounded-full transition-all hover:bg-white/5">
                    Return to Folders
                </a>
            </div>
        )}
    </main>
</Layout>

<style>
    .tag-photos {
        width: 100%;
    }

    .tag-photo-entry {
        opacity: 0;
        animation: fadeInUp 0.8s ease forwards;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Staggered animation for entries */
    .tag-photo-entry:nth-child(1) { animation-delay: 0.1s; }
    .tag-photo-entry:nth-child(2) { animation-delay: 0.2s; }
    .tag-photo-entry:nth-child(3) { animation-delay: 0.3s; }
    .tag-photo-entry:nth-child(4) { animation-delay: 0.4s; }
    .tag-photo-entry:nth-child(5) { animation-delay: 0.5s; }
</style>
